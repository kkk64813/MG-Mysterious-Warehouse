<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>印度酒店发票生成器</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --light-color: #ecf0f1;
            --dark-color: #34495e;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e4edf5 100%);
            color: var(--dark-color);
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
        }
        
        @media (max-width: 900px) {
            .container {
                grid-template-columns: 1fr;
            }
        }
        
        header {
            grid-column: 1 / -1;
            text-align: center;
            padding: 25px 0;
            margin-bottom: 25px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-size: 2.8rem;
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
        }
        
        .subtitle {
            color: var(--secondary-color);
            font-size: 1.3rem;
            max-width: 700px;
            margin: 0 auto;
            line-height: 1.8;
        }
        
        .panel {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            margin-bottom: 20px;
            transition: transform 0.3s ease;
        }
        
        .panel:hover {
            transform: translateY(-5px);
        }
        
        .panel-title {
            font-size: 1.6rem;
            color: var(--primary-color);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
            display: flex;
            align-items: center;
        }
        
        .panel-title i {
            margin-right: 10px;
            color: var(--secondary-color);
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
            display: flex;
            align-items: center;
        }
        
        label i {
            margin-right: 8px;
            color: var(--secondary-color);
            width: 20px;
            text-align: center;
        }
        
        input, select, button {
            width: 100%;
            padding: 14px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1.05rem;
            transition: all 0.3s ease;
        }
        
        input:focus, select:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
            outline: none;
        }
        
        button {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-top: 5px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        button i {
            margin-right: 8px;
        }
        
        button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        .btn-generate {
            background-color: var(--success-color);
        }
        
        .btn-generate:hover {
            background-color: #219653;
        }
        
        .btn-download {
            background-color: var(--accent-color);
            margin-top: 10px;
        }
        
        .btn-download:hover {
            background-color: #c0392b;
        }
        
        .input-group {
            display: flex;
            gap: 10px;
        }
        
        .input-group input {
            flex: 1;
        }
        
        .input-group button {
            width: auto;
            min-width: 140px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 5px;
        }
        
        .checkbox-group input {
            width: auto;
            margin-right: 10px;
        }
        
        .invoice-preview {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            min-height: 700px;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .invoice-container {
            width: 100%;
            height: 100%;
            border: 1px solid #eee;
            padding: 35px;
            position: relative;
            flex: 1;
            background: #fff;
        }
        
        .invoice-header {
            text-align: center;
            margin-bottom: 35px;
            padding-bottom: 25px;
            border-bottom: 2px solid #eee;
        }
        
        .hotel-name {
            font-size: 2.2rem;
            color: var(--primary-color);
            margin-bottom: 8px;
            font-weight: 700;
        }
        
        .hotel-address {
            color: #7f8c8d;
            margin-bottom: 12px;
            line-height: 1.6;
        }
        
        .invoice-details {
            display: flex;
            justify-content: space-between;
            margin-bottom: 35px;
        }
        
        .guest-info, .invoice-meta {
            flex: 1;
        }
        
        .invoice-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 35px;
        }
        
        .invoice-table th {
            background-color: #f8f9fa;
            padding: 14px;
            text-align: left;
            border-bottom: 2px solid #eee;
            font-weight: 600;
        }
        
        .invoice-table td {
            padding: 14px;
            border-bottom: 1px solid #eee;
        }
        
        .invoice-total {
            text-align: right;
            margin-top: 25px;
            font-size: 1.1rem;
        }
        
        .total-row {
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }
        
        .invoice-footer {
            margin-top: 50px;
            padding-top: 25px;
            border-top: 2px solid #eee;
            text-align: center;
            color: #7f8c8d;
            line-height: 1.8;
        }
        
        .actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 25px;
        }
        
        .iframe-warning {
            display: none;
            background-color: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            text-align: center;
        }
        
        .download-link {
            word-break: break-all;
            background-color: #e9ecef;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 15px;
            display: none;
            font-family: monospace;
        }
        
        .style-selector {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 15px;
            margin-top: 20px;
        }
        
        .style-box {
            height: 25px;
            border: 2px solid #ddd;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.8rem;
        }
        
        .style-box:hover, .style-box.active {
            border-color: var(--secondary-color);
            transform: scale(1.05);
        }
        
        /* Invoice Styles */
        .style-1 .invoice-header {
            border-bottom: 3px solid #3498db;
        }
        
        .style-2 .invoice-header {
            border-bottom: 3px double #e74c3c;
        }
        
        .style-3 .invoice-header {
            border-bottom: 3px dashed #2ecc71;
        }
        
        .style-4 .invoice-header {
            border-bottom: 3px dotted #9b59b6;
        }
        
        .style-5 .hotel-name {
            text-decoration: underline;
            text-decoration-color: #f1c40f;
        }
        
        .style-6 .invoice-table th {
            background-color: #d5f5e3;
        }
        
        .style-7 .invoice-table {
            border: 1px solid #ddd;
        }
        
        .style-8 .invoice-footer {
            font-style: italic;
        }
        
        .style-9 .invoice-container {
            border: 2px solid #3498db;
        }
        
        .style-10 .invoice-header {
            text-align: left;
        }
        
        .logo {
            text-align: center;
            margin-bottom: 15px;
        }
        
        .logo span {
            font-size: 2.5rem;
            color: var(--secondary-color);
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo">
                <span>INVOICE GENERATOR</span>
            </div>
            <h1>印度酒店发票生成器</h1>
            <p class="subtitle">创建专业、可定制的印度酒店发票（全英文） - 支持PDF、PNG和Word格式导出</p>
        </header>
        
        <div class="panel">
            <h2 class="panel-title"><i class="fas fa-cog"></i> 发票设置</h2>
            
            <div class="form-group">
                <label for="hotelStyle"><i class="fas fa-palette"></i> 发票样式</label>
                <div class="style-selector">
                    <div class="style-box active" data-style="1">Style 1</div>
                    <div class="style-box" data-style="2">Style 2</div>
                    <div class="style-box" data-style="3">Style 3</div>
                    <div class="style-box" data-style="4">Style 4</div>
                    <div class="style-box" data-style="5">Style 5</div>
                    <div class="style-box" data-style="6">Style 6</div>
                    <div class="style-box" data-style="7">Style 7</div>
                    <div class="style-box" data-style="8">Style 8</div>
                    <div class="style-box" data-style="9">Style 9</div>
                    <div class="style-box" data-style="10">Style 10</div>
                </div>
            </div>
            
            <div class="form-group">
                <label for="hotelName"><i class="fas fa-hotel"></i> 酒店名称</label>
                <div class="input-group">
                    <input type="text" id="hotelName" placeholder="输入酒店名称">
                    <button class="btn-generate" id="generateHotel"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="hotelTaxId"><i class="fas fa-file-invoice"></i> 酒店税号</label>
                <div class="input-group">
                    <input type="text" id="hotelTaxId" placeholder="输入税号">
                    <button class="btn-generate" id="generateTaxId"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="hotelCity"><i class="fas fa-city"></i> 城市</label>
                <select id="hotelCity">
                    <option value="">选择城市</option>
                    <option value="Mumbai">Mumbai</option>
                    <option value="Delhi">Delhi</option>
                    <option value="Bangalore">Bangalore</option>
                    <option value="Hyderabad">Hyderabad</option>
                    <option value="Ahmedabad">Ahmedabad</option>
                    <option value="Chennai">Chennai</option>
                    <option value="Kolkata">Kolkata</option>
                    <option value="Surat">Surat</option>
                    <option value="Pune">Pune</option>
                    <option value="Jaipur">Jaipur</option>
                    <option value="Lucknow">Lucknow</option>
                    <option value="Kanpur">Kanpur</option>
                    <option value="Nagpur">Nagpur</option>
                    <option value="Visakhapatnam">Visakhapatnam</option>
                    <option value="Indore">Indore</option>
                    <option value="Thane">Thane</option>
                    <option value="Bhopal">Bhopal</option>
                    <option value="Patna">Patna</option>
                    <option value="Vadodara">Vadodara</option>
                    <option value="Ghaziabad">Ghaziabad</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="hotelAddress"><i class="fas fa-map-marker-alt"></i> 酒店地址</label>
                <input type="text" id="hotelAddress" placeholder="酒店地址将根据城市自动生成">
            </div>
            
            <div class="form-group">
                <label for="staffName"><i class="fas fa-user-tie"></i> 服务人员姓名</label>
                <div class="input-group">
                    <input type="text" id="staffName" placeholder="输入服务人员姓名">
                    <button class="btn-generate" id="generateStaff"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="guestName"><i class="fas fa-user"></i> 入住人姓名</label>
                <div class="input-group">
                    <input type="text" id="guestName" placeholder="输入入住人姓名">
                    <button class="btn-generate" id="generateGuest"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="roomNumber"><i class="fas fa-door-open"></i> 房号</label>
                <div class="input-group">
                    <input type="text" id="roomNumber" placeholder="输入房号">
                    <button class="btn-generate" id="generateRoom"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
            
            <div class="form-group">
                <label for="roomRate"><i class="fas fa-money-bill-wave"></i> 每晚房价 (₹)</label>
                <input type="number" id="roomRate" placeholder="输入每晚房价" min="0" value="4500">
            </div>
            
            <div class="form-group">
                <label for="checkinDate"><i class="fas fa-calendar-check"></i> 入住日期</label>
                <input type="date" id="checkinDate">
            </div>
            
            <div class="form-group">
                <label for="stayDays"><i class="fas fa-moon"></i> 入住天数</label>
                <input type="number" id="stayDays" placeholder="输入天数" min="1" value="3">
            </div>
            
            <div class="form-group">
                <label for="advancePayment"><i class="fas fa-credit-card"></i> 预付款金额 (₹)</label>
                <input type="number" id="advancePayment" placeholder="输入预付款金额" min="0" value="5000">
            </div>
            
            <div class="form-group">
                <label for="gstRate"><i class="fas fa-percent"></i> GST税率 (%)</label>
                <input type="number" id="gstRate" placeholder="输入GST税率" min="0" max="100" value="18">
            </div>
            
            <div class="form-group">
                <label for="currency"><i class="fas fa-coins"></i> 币别</label>
                <select id="currency">
                    <option value="₹">印度卢比 (₹)</option>
                    <option value="$">美元 ($)</option>
                    <option value="€">欧元 (€)</option>
                    <option value="£">英镑 (£)</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="paymentMethod"><i class="fas fa-wallet"></i> 支付方式</label>
                <select id="paymentMethod">
                    <option value="Cash">现金</option>
                    <option value="Credit Card">信用卡</option>
                    <option value="Debit Card">借记卡</option>
                    <option value="Bank Transfer">银行转账</option>
                    <option value="UPI">UPI</option>
                </select>
            </div>
            
            <div class="form-group" id="cardNumberGroup" style="display: none;">
                <label for="cardNumber"><i class="fas fa-credit-card"></i> 信用卡尾号</label>
                <input type="text" id="cardNumber" placeholder="输入信用卡尾号" value="3357">
            </div>
            
            <div class="form-group">
                <label for="transactionId"><i class="fas fa-receipt"></i> 交易ID</label>
                <div class="input-group">
                    <input type="text" id="transactionId" placeholder="输入交易ID">
                    <button class="btn-generate" id="generateTransaction"><i class="fas fa-random"></i> 随机生成</button>
                </div>
            </div>
        </div>
        
        <div class="invoice-preview">
            <h2 class="panel-title"><i class="fas fa-eye"></i> 发票预览</h2>
            <div class="invoice-container" id="invoice">
                <div class="invoice-header">
                    <div class="hotel-name" id="previewHotelName">Grand Taj Palace</div>
                    <div class="hotel-address" id="previewHotelAddress">123 Luxury Road, Mumbai, Maharashtra 400001</div>
                    <div>Tax ID: <span id="previewTaxId">GSTIN98765XYZ</span></div>
                </div>
                
                <div class="invoice-details">
                    <div class="guest-info">
                        <div><strong>Guest:</strong> <span id="previewGuestName">Robert Johnson</span></div>
                        <div><strong>Room No:</strong> <span id="previewRoom">304</span></div>
                        <div><strong>Check-in:</strong> <span id="previewCheckin">15 Jul 2023</span></div>
                        <div><strong>Check-out:</strong> <span id="previewCheckout">18 Jul 2023</span></div>
                    </div>
                    
                    <div class="invoice-meta">
                        <div><strong>Invoice No:</strong> <span id="previewInvoiceNo">INV-20230715-001</span></div>
                        <div><strong>Date:</strong> <span id="previewInvoiceDate">18 Jul 2023</span></div>
                        <div><strong>Staff:</strong> <span id="previewStaff">Amit Sharma</span></div>
                    </div>
                </div>
                
                <table class="invoice-table">
                    <thead>
                        <tr>
                            <th>Description</th>
                            <th>Days</th>
                            <th>Rate</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Deluxe Room Accommodation</td>
                            <td id="previewDays">3</td>
                            <td id="previewRate">₹4,500.00</td>
                            <td id="previewRoomTotal">₹13,500.00</td>
                        </tr>
                        <tr>
                            <td>Restaurant Charges</td>
                            <td>1</td>
                            <td>₹2,350.00</td>
                            <td>₹2,350.00</td>
                        </tr>
                        <tr>
                            <td>Laundry Service</td>
                            <td>1</td>
                            <td>₹780.00</td>
                            <td>₹780.00</td>
                        </tr>
                    </tbody>
                </table>
                
                <div class="invoice-total">
                    <div class="total-row">Subtotal: <span id="previewSubtotal">₹16,630.00</span></div>
                    <div>GST (<span id="previewGstRate">18</span>%): <span id="previewGstAmount">₹2,993.40</span></div>
                    <div class="total-row">Total: <span id="previewTotal">₹19,623.40</span></div>
                    <div>Advance Paid: <span id="previewAdvance">₹5,000.00</span></div>
                    <div class="total-row">Amount Due: <span id="previewDue">₹14,623.40</span></div>
                </div>
                
                <div class="invoice-footer">
                    <div>Payment Method: <span id="previewPayment">Credit Card (**** **** **** 3357)</span></div>
                    <div>Transaction ID: <span id="previewTransaction">TXID9876543210</span></div>
                    <div>Thank you for your stay. We hope to see you again soon!</div>
                </div>
            </div>
            
            <div class="actions">
                <button class="btn-download" id="downloadPdf"><i class="fas fa-file-pdf"></i> 下载 PDF</button>
                <button class="btn-download" id="downloadPng"><i class="fas fa-file-image"></i> 下载 PNG</button>
                <button class="btn-download" id="downloadWord"><i class="fas fa-file-word"></i> 下载 Word</button>
            </div>
            
            <div class="iframe-warning" id="iframeWarning">
                检测到您在iframe中浏览。请复制以下链接并在新标签页中打开以下载文件：
            </div>
            
            <div class="download-link" id="downloadLink"></div>
        </div>
    </div>

    <!-- Font Awesome for icons -->
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
    
    <script>
        // 初始化变量
        const hotelBrands = [
            "Taj Hotels", "Oberoi Hotels & Resorts", "ITC Hotels", "Leela Palaces", 
            "Marriott India", "Hyatt India", "Hilton India", "Radisson India",
            "Lemon Tree Hotels", "Treebo Hotels", "FabHotels", "OYO Premium",
            "Sarovar Hotels", "Royal Orchid Hotels", "The Fern Hotels", "Tribute Portfolio",
            "Alila Hotels", "St. Regis", "Four Seasons", "Ritz-Carlton"
        ];
        
        const staffNames = [
            "Rajesh Kumar", "Priya Sharma", "Amit Patel", "Deepak Singh", "Sunita Verma",
            "Vikram Mehta", "Anjali Reddy", "Suresh Nair", "Neha Gupta", "Arun Joshi",
            "Kavita Mishra", "Rahul Desai", "Pooja Shah", "Sanjay Malhotra", "Meera Iyer"
        ];
        
        const guestNames = [
            "Robert Johnson", "Emily Chen", "David Williams", "Sarah Brown", "Michael Davis",
            "Jennifer Wilson", "Christopher Lee", "Jessica Taylor", "Matthew Anderson", "Amanda Thomas",
            "Daniel Martinez", "Olivia Jackson", "James White", "Sophia Harris", "William Martin"
        ];
        
        // 城市地址映射
        const cityAddresses = {
            "Mumbai": "123 Marine Drive, Mumbai, Maharashtra 400001",
            "Delhi": "45 Connaught Place, New Delhi, Delhi 110001",
            "Bangalore": "78 MG Road, Bangalore, Karnataka 560001",
            "Hyderabad": "34 Jubilee Hills, Hyderabad, Telangana 500033",
            "Ahmedabad": "22 C.G. Road, Ahmedabad, Gujarat 380009",
            "Chennai": "56 Mount Road, Chennai, Tamil Nadu 600002",
            "Kolkata": "89 Park Street, Kolkata, West Bengal 700016",
            "Surat": "12 Ring Road, Surat, Gujarat 395002",
            "Pune": "67 Fergusson Road, Pune, Maharashtra 411001",
            "Jaipur": "23 MI Road, Jaipur, Rajasthan 302001",
            "Lucknow": "11 Hazratganj, Lucknow, Uttar Pradesh 226001",
            "Kanpur": "88 Mall Road, Kanpur, Uttar Pradesh 208001",
            "Nagpur": "44 Wardha Road, Nagpur, Maharashtra 440001",
            "Visakhapatnam": "33 Beach Road, Visakhapatnam, Andhra Pradesh 530001",
            "Indore": "99 Vijay Nagar, Indore, Madhya Pradesh 452001",
            "Thane": "55 Ghodbunder Road, Thane, Maharashtra 400601",
            "Bhopal": "77 Arera Hills, Bhopal, Madhya Pradesh 462001",
            "Patna": "66 Fraser Road, Patna, Bihar 800001",
            "Vadodara": "34 R.C. Dutt Road, Vadodara, Gujarat 390001",
            "Ghaziabad": "88 Raj Nagar, Ghaziabad, Uttar Pradesh 201001"
        };
        
        // 初始化日期
        document.getElementById('checkinDate').valueAsDate = new Date();
        
        // 事件监听器
        document.getElementById('generateHotel').addEventListener('click', generateRandomHotel);
        document.getElementById('generateTaxId').addEventListener('click', generateRandomTaxId);
        document.getElementById('hotelCity').addEventListener('change', updateHotelAddress);
        document.getElementById('generateStaff').addEventListener('click', generateRandomStaff);
        document.getElementById('generateGuest').addEventListener('click', generateRandomGuest);
        document.getElementById('generateRoom').addEventListener('click', generateRandomRoom);
        document.getElementById('generateTransaction').addEventListener('click', generateRandomTransaction);
        document.getElementById('paymentMethod').addEventListener('change', toggleCardNumber);
        document.getElementById('downloadPdf').addEventListener('click', () => downloadInvoice('pdf'));
        document.getElementById('downloadPng').addEventListener('click', () => downloadInvoice('png'));
        document.getElementById('downloadWord').addEventListener('click', () => downloadInvoice('word'));
        
        // 样式选择器
        const styleBoxes = document.querySelectorAll('.style-box');
        styleBoxes.forEach(box => {
            box.addEventListener('click', () => {
                styleBoxes.forEach(b => b.classList.remove('active'));
                box.classList.add('active');
                const style = box.getAttribute('data-style');
                document.getElementById('invoice').className = `invoice-container style-${style}`;
            });
        });
        
        // 表单输入事件
        const inputFields = [
            'hotelName', 'hotelTaxId', 'hotelCity', 'hotelAddress', 'staffName', 
            'guestName', 'roomNumber', 'roomRate', 'checkinDate', 'stayDays', 
            'advancePayment', 'gstRate', 'currency', 'paymentMethod', 'cardNumber', 'transactionId'
        ];
        
        inputFields.forEach(field => {
            document.getElementById(field).addEventListener('input', updateInvoicePreview);
        });
        
        // 初始化预览
        generateRandomHotel();
        generateRandomTaxId();
        updateHotelAddress();
        generateRandomStaff();
        generateRandomGuest();
        generateRandomRoom();
        generateRandomTransaction();
        updateInvoicePreview();
        
        // 函数定义
        function generateRandomHotel() {
            const randomIndex = Math.floor(Math.random() * hotelBrands.length);
            document.getElementById('hotelName').value = hotelBrands[randomIndex];
            updateInvoicePreview();
        }
        
        function generateRandomTaxId() {
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let taxId = 'GSTIN';
            
            for (let i = 0; i < 6; i++) {
                taxId += Math.floor(Math.random() * 10);
            }
            
            for (let i = 0; i < 3; i++) {
                taxId += letters.charAt(Math.floor(Math.random() * letters.length));
            }
            
            document.getElementById('hotelTaxId').value = taxId;
            updateInvoicePreview();
        }
        
        function updateHotelAddress() {
            const city = document.getElementById('hotelCity').value;
            if (city && cityAddresses[city]) {
                document.getElementById('hotelAddress').value = cityAddresses[city];
                updateInvoicePreview();
            }
        }
        
        function generateRandomStaff() {
            const randomIndex = Math.floor(Math.random() * staffNames.length);
            document.getElementById('staffName').value = staffNames[randomIndex];
            updateInvoicePreview();
        }
        
        function generateRandomGuest() {
            const randomIndex = Math.floor(Math.random() * guestNames.length);
            document.getElementById('guestName').value = guestNames[randomIndex];
            updateInvoicePreview();
        }
        
        function generateRandomRoom() {
            const floor = Math.floor(Math.random() * 10) + 1;
            const room = Math.floor(Math.random() * 30) + 1;
            document.getElementById('roomNumber').value = `${floor}${room < 10 ? '0' : ''}${room}`;
            updateInvoicePreview();
        }
        
        function generateRandomTransaction() {
            let transactionId = 'TXID';
            for (let i = 0; i < 10; i++) {
                transactionId += Math.floor(Math.random() * 10);
            }
            document.getElementById('transactionId').value = transactionId;
            updateInvoicePreview();
        }
        
        function toggleCardNumber() {
            const method = document.getElementById('paymentMethod').value;
            const cardGroup = document.getElementById('cardNumberGroup');
            cardGroup.style.display = method === 'Credit Card' ? 'block' : 'none';
            updateInvoicePreview();
        }
        
        function formatCurrency(amount, currency) {
            return currency + amount.toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
        }
        
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric' 
            });
        }
        
        function updateInvoicePreview() {
            // 获取表单值
            const hotelName = document.getElementById('hotelName').value || 'Grand Taj Palace';
            const hotelAddress = document.getElementById('hotelAddress').value || '123 Luxury Road, Mumbai, Maharashtra 400001';
            const taxId = document.getElementById('hotelTaxId').value || 'GSTIN98765XYZ';
            const staffName = document.getElementById('staffName').value || 'Amit Sharma';
            const guestName = document.getElementById('guestName').value || 'Robert Johnson';
            const roomNumber = document.getElementById('roomNumber').value || '304';
            const roomRate = parseFloat(document.getElementById('roomRate').value) || 4500;
            const advancePayment = parseFloat(document.getElementById('advancePayment').value) || 5000;
            const gstRate = parseFloat(document.getElementById('gstRate').value) || 18;
            const currency = document.getElementById('currency').value || '₹';
            const checkinDate = document.getElementById('checkinDate').value;
            const stayDays = parseInt(document.getElementById('stayDays').value) || 3;
            const paymentMethod = document.getElementById('paymentMethod').value;
            const cardNumber = document.getElementById('cardNumber').value || '3357';
            const transactionId = document.getElementById('transactionId').value || 'TXID9876543210';
            
            // 计算日期
            let checkoutDate = '';
            let invoiceDate = '';
            
            if (checkinDate) {
                const checkin = new Date(checkinDate);
                const checkout = new Date(checkin);
                checkout.setDate(checkout.getDate() + stayDays);
                checkoutDate = formatDate(checkout);
                
                // 发票日期为退房日期
                invoiceDate = checkoutDate;
            }
            
            // 计算金额
            const roomTotal = roomRate * stayDays;
            const restaurantCharges = 2350;
            const laundryCharges = 780;
            const subtotal = roomTotal + restaurantCharges + laundryCharges;
            const gstAmount = subtotal * (gstRate / 100);
            const total = subtotal + gstAmount;
            const due = total - advancePayment;
            
            // 更新预览
            document.getElementById('previewHotelName').textContent = hotelName;
            document.getElementById('previewHotelAddress').textContent = hotelAddress;
            document.getElementById('previewTaxId').textContent = taxId;
            document.getElementById('previewGuestName').textContent = guestName;
            document.getElementById('previewRoom').textContent = roomNumber;
            document.getElementById('previewCheckin').textContent = formatDate(checkinDate) || '15 Jul 2023';
            document.getElementById('previewCheckout').textContent = checkoutDate || '18 Jul 2023';
            document.getElementById('previewStaff').textContent = staffName;
            document.getElementById('previewInvoiceDate').textContent = invoiceDate || '18 Jul 2023';
            
            document.getElementById('previewDays').textContent = stayDays;
            document.getElementById('previewRate').textContent = formatCurrency(roomRate, currency);
            document.getElementById('previewRoomTotal').textContent = formatCurrency(roomTotal, currency);
            document.getElementById('previewSubtotal').textContent = formatCurrency(subtotal, currency);
            document.getElementById('previewGstRate').textContent = gstRate;
            document.getElementById('previewGstAmount').textContent = formatCurrency(gstAmount, currency);
            document.getElementById('previewTotal').textContent = formatCurrency(total, currency);
            document.getElementById('previewAdvance').textContent = formatCurrency(advancePayment, currency);
            document.getElementById('previewDue').textContent = formatCurrency(due, currency);
            
            // 生成发票号
            const today = new Date();
            const invoiceNo = `INV-${today.getFullYear()}${(today.getMonth()+1).toString().padStart(2, '0')}${today.getDate().toString().padStart(2, '0')}-${Math.floor(Math.random()*1000).toString().padStart(3, '0')}`;
            document.getElementById('previewInvoiceNo').textContent = invoiceNo;
            
            // 更新支付方式
            const paymentDisplay = paymentMethod === 'Credit Card' 
                ? `Credit Card (**** **** **** ${cardNumber})` 
                : paymentMethod;
            document.getElementById('previewPayment').textContent = paymentDisplay;
            
            document.getElementById('previewTransaction').textContent = transactionId;
        }
        
        function downloadInvoice(format) {
            const invoiceElement = document.getElementById('invoice');
            const hotelName = document.getElementById('hotelName').value || 'HotelInvoice';
            const fileName = `${hotelName.replace(/\s+/g, '_')}_Invoice_${new Date().toISOString().slice(0, 10)}`;
            
            // 检查是否在iframe中
            const isInIframe = window.self !== window.top;
            
            if (isInIframe) {
                // 在iframe中，显示链接
                const iframeWarning = document.getElementById('iframeWarning');
                const downloadLink = document.getElementById('downloadLink');
                
                // 生成唯一的下载标识符
                const downloadId = `dl_${Date.now()}_${Math.random().toString(36).substr(2, 5)}`;
                
                // 存储数据在本地（简化处理）
                localStorage.setItem(downloadId, JSON.stringify({
                    format: format,
                    fileName: fileName,
                    html: invoiceElement.innerHTML
                }));
                
                // 创建下载链接
                const downloadUrl = `${window.location.href.split('?')[0]}?download=${downloadId}`;
                downloadLink.textContent = downloadUrl;
                downloadLink.style.display = 'block';
                iframeWarning.style.display = 'block';
                
                return;
            }
            
            // 不在iframe中，直接下载
            if (format === 'pdf') {
                generatePDF(invoiceElement, fileName);
            } else if (format === 'png') {
                generatePNG(invoiceElement, fileName);
            } else if (format === 'word') {
                generateWord(invoiceElement, fileName);
            }
        }
        
        function generatePDF(element, fileName) {
            html2canvas(element, {
                scale: 2,
                useCORS: true
            }).then(canvas => {
                const imgData = canvas.toDataURL('image/png');
                const pdf = new jspdf.jsPDF('p', 'mm', 'a4');
                const imgWidth = 210; // A4 width in mm
                const pageHeight = 295; // A4 height in mm
                const imgHeight = canvas.height * imgWidth / canvas.width;
                
                pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
                pdf.save(`${fileName}.pdf`);
            }).catch(error => {
                console.error('Error generating PDF:', error);
                alert('生成PDF时出错，请重试');
            });
        }
        
        function generatePNG(element, fileName) {
            html2canvas(element, {
                scale: 2,
                useCORS: true
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    saveAs(blob, `${fileName}.png`);
                });
            }).catch(error => {
                console.error('Error generating PNG:', error);
                alert('生成PNG时出错，请重试');
            });
        }
        
        function generateWord(element, fileName) {
            const htmlContent = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>${fileName}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 1.5cm;
                        }
                        .invoice-container { 
                            width: 100%; 
                            max-width: 21cm;
                            margin: 0 auto;
                        }
                        .invoice-header {
                            text-align: center;
                            margin-bottom: 35px;
                            padding-bottom: 25px;
                            border-bottom: 2px solid #eee;
                        }
                        .hotel-name {
                            font-size: 24pt;
                            font-weight: bold;
                            margin-bottom: 10px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin-bottom: 30px;
                        }
                        th, td {
                            padding: 10px;
                            border: 1px solid #ddd;
                        }
                        th {
                            background-color: #f5f5f5;
                        }
                        .invoice-total {
                            text-align: right;
                            margin-top: 30px;
                            font-size: 12pt;
                        }
                    </style>
                </head>
                <body>
                    ${element.innerHTML}
                </body>
                </html>
            `;
            
            const blob = new Blob([htmlContent], { type: 'application/msword' });
            const link = document.createElement('a');
            link.download = `${fileName}.doc`;
            link.href = URL.createObjectURL(blob);
            link.click();
        }
        
        // 检查URL参数，处理下载请求
        function checkDownloadRequest() {
            const urlParams = new URLSearchParams(window.location.search);
            const downloadId = urlParams.get('download');
            
            if (downloadId) {
                const downloadData = JSON.parse(localStorage.getItem(downloadId) || '{}');
                localStorage.removeItem(downloadId);
                
                const element = document.createElement('div');
                element.innerHTML = downloadData.html || '<div>Error: Invoice content not found</div>';
                
                if (downloadData.format === 'pdf') {
                    generatePDF(element, downloadData.fileName);
                } else if (downloadData.format === 'png') {
                    generatePNG(element, downloadData.fileName);
                } else if (downloadData.format === 'word') {
                    generateWord(element, downloadData.fileName);
                }
                
                // 关闭窗口
                setTimeout(() => {
                    window.close();
                }, 3000);
            }
        }
        
        // 初始化检查下载请求
        window.onload = checkDownloadRequest;
    </script>
</body>
</html>
